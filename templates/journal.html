{% extends "base.html" %} {% block title %}Private Journal - Youth Mental
Wellness{% endblock %} {% block head %}
<style>
	.journal-entry {
		background: #f8f9fa;
		border-radius: 10px;
		padding: 20px;
		margin-bottom: 20px;
		border-left: 4px solid #007bff;
	}

	.journal-entry.encrypted {
		background: #fff3cd;
		border-left-color: #ffc107;
	}

	.mood-indicator {
		display: inline-block;
		width: 20px;
		height: 20px;
		border-radius: 50%;
		margin-right: 10px;
	}

	.mood-1 {
		background-color: #dc3545;
	}
	.mood-2 {
		background-color: #fd7e14;
	}
	.mood-3 {
		background-color: #ffc107;
	}
	.mood-4 {
		background-color: #28a745;
	}
	.mood-5 {
		background-color: #20c997;
	}
	.mood-6 {
		background-color: #17a2b8;
	}
	.mood-7 {
		background-color: #007bff;
	}
	.mood-8 {
		background-color: #6f42c1;
	}
	.mood-9 {
		background-color: #e83e8c;
	}
	.mood-10 {
		background-color: #6c757d;
	}

	.tag {
		display: inline-block;
		background: #e9ecef;
		padding: 2px 8px;
		border-radius: 12px;
		font-size: 0.8em;
		margin: 2px;
	}

	.stats-card {
		background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		color: white;
		border-radius: 15px;
		padding: 20px;
		margin-bottom: 20px;
	}

	.search-container {
		position: relative;
		margin-bottom: 20px;
	}

	.search-input {
		width: 100%;
		padding: 12px 45px 12px 15px;
		border: 2px solid #ddd;
		border-radius: 25px;
		font-size: 16px;
	}

	.search-btn {
		position: absolute;
		right: 10px;
		top: 50%;
		transform: translateY(-50%);
		background: none;
		border: none;
		color: #666;
	}

	.filter-tabs {
		margin-bottom: 20px;
	}

	.filter-tabs .nav-link {
		border-radius: 20px;
		margin: 0 5px;
	}

	.filter-tabs .nav-link.active {
		background: #007bff;
		color: white;
	}

	.new-entry-form {
		background: white;
		border-radius: 15px;
		padding: 25px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		margin-bottom: 30px;
	}

	.form-group {
		margin-bottom: 20px;
	}

	.form-control {
		border-radius: 8px;
		border: 2px solid #e9ecef;
		padding: 12px;
	}

	.form-control:focus {
		border-color: #007bff;
		box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
	}

	.btn-primary {
		background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
		border: none;
		border-radius: 25px;
		padding: 12px 30px;
		font-weight: 600;
	}

	.btn-secondary {
		border-radius: 25px;
		padding: 8px 20px;
	}

	.mood-slider {
		-webkit-appearance: none;
		width: 100%;
		height: 8px;
		border-radius: 4px;
		background: linear-gradient(
			to right,
			#dc3545,
			#fd7e14,
			#ffc107,
			#28a745,
			#20c997,
			#17a2b8,
			#007bff,
			#6f42c1,
			#e83e8c,
			#6c757d
		);
		outline: none;
	}

	.mood-slider::-webkit-slider-thumb {
		-webkit-appearance: none;
		appearance: none;
		width: 20px;
		height: 20px;
		border-radius: 50%;
		background: white;
		border: 2px solid #007bff;
		cursor: pointer;
	}

	.mood-slider::-moz-range-thumb {
		width: 20px;
		height: 20px;
		border-radius: 50%;
		background: white;
		border: 2px solid #007bff;
		cursor: pointer;
	}

	.mood-labels {
		display: flex;
		justify-content: space-between;
		font-size: 0.8em;
		color: #666;
		margin-top: 5px;
	}

	.tag-input-container {
		position: relative;
	}

	.tag-input {
		width: 100%;
		padding: 8px 35px 8px 12px;
		border: 1px solid #ddd;
		border-radius: 4px;
	}

	.add-tag-btn {
		position: absolute;
		right: 8px;
		top: 50%;
		transform: translateY(-50%);
		background: none;
		border: none;
		color: #007bff;
		cursor: pointer;
	}

	.tags-display {
		margin-top: 10px;
	}

	.decrypt-btn {
		background: #ffc107;
		color: #000;
		border: none;
		border-radius: 15px;
		padding: 5px 15px;
		font-size: 0.8em;
	}

	.decrypt-btn:hover {
		background: #e0a800;
		color: #000;
	}
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
	<div class="row">
		<div class="col-12">
			<h1 class="text-center mb-4">
				<i class="fas fa-book-open text-primary"></i>
				Private Journal
			</h1>
			<p class="text-center text-muted mb-5">
				Your thoughts, safely encrypted and stored. Express yourself freely.
			</p>
		</div>
	</div>

	<!-- Stats Overview -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="stats-card">
				<div class="d-flex align-items-center">
					<i class="fas fa-pen-fancy fa-2x me-3"></i>
					<div>
						<h4 id="total-entries">0</h4>
						<small>Total Entries</small>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="stats-card">
				<div class="d-flex align-items-center">
					<i class="fas fa-fire fa-2x me-3"></i>
					<div>
						<h4 id="writing-streak">0</h4>
						<small>Day Streak</small>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="stats-card">
				<div class="d-flex align-items-center">
					<i class="fas fa-chart-line fa-2x me-3"></i>
					<div>
						<h4 id="avg-mood">0</h4>
						<small>Avg Mood</small>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="stats-card">
				<div class="d-flex align-items-center">
					<i class="fas fa-tags fa-2x me-3"></i>
					<div>
						<h4 id="total-tags">0</h4>
						<small>Unique Tags</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- New Entry Form -->
	<div class="new-entry-form" id="new-entry-form">
		<h3 class="mb-4">
			<i class="fas fa-plus-circle text-primary"></i>
			New Journal Entry
		</h3>

		<form id="journal-form">
			<div class="row">
				<div class="col-md-8">
					<div class="form-group">
						<label for="entry-title">Title (Optional)</label>
						<input
							type="text"
							class="form-control"
							id="entry-title"
							placeholder="Give your entry a title..."
						/>
					</div>
				</div>
				<div class="col-md-4">
					<div class="form-group">
						<label>Encryption</label>
						<div class="form-check">
							<input
								class="form-check-input"
								type="checkbox"
								id="encrypt-entry"
								checked
							/>
							<label class="form-check-label" for="encrypt-entry">
								Encrypt this entry
							</label>
						</div>
					</div>
				</div>
			</div>

			<div class="form-group">
				<label for="entry-content">What's on your mind?</label>
				<textarea
					class="form-control"
					id="entry-content"
					rows="6"
					placeholder="Write your thoughts here... This space is yours."
				></textarea>
			</div>

			<div class="row">
				<div class="col-md-6">
					<div class="form-group">
						<label>Mood Before Writing</label>
						<input
							type="range"
							class="mood-slider"
							id="mood-before"
							min="1"
							max="10"
							value="5"
						/>
						<div class="mood-labels">
							<span>😢</span>
							<span>😕</span>
							<span>😐</span>
							<span>🙂</span>
							<span>😊</span>
							<span>😄</span>
							<span>😁</span>
							<span>🤩</span>
							<span>😍</span>
							<span>🤗</span>
						</div>
					</div>
				</div>
				<div class="col-md-6">
					<div class="form-group">
						<label>Mood After Writing</label>
						<input
							type="range"
							class="mood-slider"
							id="mood-after"
							min="1"
							max="10"
							value="5"
						/>
						<div class="mood-labels">
							<span>😢</span>
							<span>😕</span>
							<span>😐</span>
							<span>🙂</span>
							<span>😊</span>
							<span>😄</span>
							<span>😁</span>
							<span>🤩</span>
							<span>😍</span>
							<span>🤗</span>
						</div>
					</div>
				</div>
			</div>

			<div class="form-group">
				<label>Tags</label>
				<div class="tag-input-container">
					<input
						type="text"
						class="tag-input"
						id="tag-input"
						placeholder="Add tags (press Enter)"
					/>
					<button type="button" class="add-tag-btn" id="add-tag-btn">
						<i class="fas fa-plus"></i>
					</button>
				</div>
				<div class="tags-display" id="tags-display"></div>
			</div>

			<div class="text-center">
				<button type="submit" class="btn btn-primary btn-lg">
					<i class="fas fa-save"></i>
					Save Entry
				</button>
				<button type="button" class="btn btn-secondary" id="cancel-btn">
					<i class="fas fa-times"></i>
					Cancel
				</button>
			</div>
		</form>
	</div>

	<!-- Search and Filters -->
	<div class="row mb-4">
		<div class="col-md-8">
			<div class="search-container">
				<input
					type="text"
					class="search-input"
					id="search-input"
					placeholder="Search your journal entries..."
				/>
				<button class="search-btn" id="search-btn">
					<i class="fas fa-search"></i>
				</button>
			</div>
		</div>
		<div class="col-md-4">
			<ul class="nav nav-pills filter-tabs" id="filter-tabs" role="tablist">
				<li class="nav-item">
					<a
						class="nav-link active"
						id="all-tab"
						data-toggle="pill"
						href="#all"
						role="tab"
						>All</a
					>
				</li>
				<li class="nav-item">
					<a
						class="nav-link"
						id="encrypted-tab"
						data-toggle="pill"
						href="#encrypted"
						role="tab"
						>Encrypted</a
					>
				</li>
				<li class="nav-item">
					<a
						class="nav-link"
						id="decrypted-tab"
						data-toggle="pill"
						href="#decrypted"
						role="tab"
						>Decrypted</a
					>
				</li>
			</ul>
		</div>
	</div>

	<!-- Journal Entries -->
	<div id="entries-container">
		<!-- Entries will be loaded here -->
	</div>

	<!-- Load More Button -->
	<div class="text-center mt-4" id="load-more-container" style="display: none">
		<button class="btn btn-outline-primary" id="load-more-btn">
			<i class="fas fa-plus"></i>
			Load More Entries
		</button>
	</div>
</div>

<!-- Entry Modal -->
<div class="modal fade" id="entryModal" tabindex="-1" role="dialog">
	<div class="modal-dialog modal-lg" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="entryModalTitle">Journal Entry</h5>
				<button type="button" class="close" data-dismiss="modal">
					<span>&times;</span>
				</button>
			</div>
			<div class="modal-body" id="entryModalBody">
				<!-- Entry content will be loaded here -->
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">
					Close
				</button>
				<button type="button" class="btn btn-primary" id="edit-entry-btn">
					Edit
				</button>
				<button type="button" class="btn btn-danger" id="delete-entry-btn">
					Delete
				</button>
			</div>
		</div>
	</div>
</div>
{% endblock %} {% block scripts %}
<script>
	let currentOffset = 0;
	const limit = 10;
	let currentFilter = "all";
	let currentSearch = "";

	document.addEventListener("DOMContentLoaded", function () {
		loadStats();
		loadEntries();
		setupEventListeners();
	});

	function setupEventListeners() {
		// Form submission
		document
			.getElementById("journal-form")
			.addEventListener("submit", handleFormSubmit);

		// Search
		document
			.getElementById("search-input")
			.addEventListener("input", debounce(handleSearch, 500));
		document
			.getElementById("search-btn")
			.addEventListener("click", handleSearch);

		// Filter tabs
		document.querySelectorAll("#filter-tabs .nav-link").forEach((tab) => {
			tab.addEventListener("click", function (e) {
				e.preventDefault();
				currentFilter = this.id.replace("-tab", "");
				document
					.querySelectorAll("#filter-tabs .nav-link")
					.forEach((t) => t.classList.remove("active"));
				this.classList.add("active");
				resetAndLoadEntries();
			});
		});

		// Tag input
		document
			.getElementById("tag-input")
			.addEventListener("keypress", function (e) {
				if (e.key === "Enter") {
					e.preventDefault();
					addTag();
				}
			});
		document.getElementById("add-tag-btn").addEventListener("click", addTag);

		// Load more
		document
			.getElementById("load-more-btn")
			.addEventListener("click", loadMoreEntries);

		// Cancel button
		document.getElementById("cancel-btn").addEventListener("click", resetForm);
	}

	function handleFormSubmit(e) {
		e.preventDefault();

		const formData = {
			title: document.getElementById("entry-title").value,
			content: document.getElementById("entry-content").value,
			mood_before: parseInt(document.getElementById("mood-before").value),
			mood_after: parseInt(document.getElementById("mood-after").value),
			tags: getCurrentTags(),
			encrypt: document.getElementById("encrypt-entry").checked,
		};

		if (!formData.content.trim()) {
			alert("Please write something in your journal entry.");
			return;
		}

		fetch("/api/journal/entry", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
			body: JSON.stringify(formData),
		})
			.then((response) => response.json())
			.then((data) => {
				if (data.success) {
					resetForm();
					resetAndLoadEntries();
					loadStats();
					showNotification("Journal entry saved successfully!", "success");
				} else {
					showNotification("Error saving entry: " + data.error, "error");
				}
			})
			.catch((error) => {
				console.error("Error:", error);
				showNotification("Error saving entry", "error");
			});
	}

	function loadStats() {
		fetch("/api/journal/stats")
			.then((response) => response.json())
			.then((data) => {
				const stats = data.stats;
				document.getElementById("total-entries").textContent =
					stats.total_entries;
				document.getElementById("writing-streak").textContent =
					stats.writing_streak || 0;
				document.getElementById("avg-mood").textContent =
					stats.average_mood_after
						? stats.average_mood_after.toFixed(1)
						: "N/A";
				document.getElementById("total-tags").textContent = stats.unique_tags;
			})
			.catch((error) => console.error("Error loading stats:", error));
	}

	function loadEntries(reset = true) {
		if (reset) {
			currentOffset = 0;
			document.getElementById("entries-container").innerHTML = "";
		}

		let url = `/api/journal/entries?limit=${limit}&offset=${currentOffset}`;
		if (currentSearch) {
			url = `/api/journal/search?q=${encodeURIComponent(
				currentSearch
			)}&limit=${limit}&offset=${currentOffset}`;
		}

		fetch(url)
			.then((response) => response.json())
			.then((data) => {
				const container = document.getElementById("entries-container");
				const loadMoreContainer = document.getElementById(
					"load-more-container"
				);

				if (data.entries.length === 0 && reset) {
					container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No journal entries yet</h4>
                    <p class="text-muted">Start writing your first entry above!</p>
                </div>
            `;
					loadMoreContainer.style.display = "none";
					return;
				}

				data.entries.forEach((entry) => {
					const entryElement = createEntryElement(entry);
					container.appendChild(entryElement);
				});

				if (data.entries.length === limit) {
					loadMoreContainer.style.display = "block";
				} else {
					loadMoreContainer.style.display = "none";
				}

				currentOffset += data.entries.length;
			})
			.catch((error) => console.error("Error loading entries:", error));
	}

	function createEntryElement(entry) {
		const div = document.createElement("div");
		div.className = `journal-entry ${entry.is_encrypted ? "encrypted" : ""}`;
		div.setAttribute("data-entry-id", entry.id);

		const moodBeforeHtml = entry.mood_before
			? `<span class="mood-indicator mood-${entry.mood_before}"></span>`
			: "";
		const moodAfterHtml = entry.mood_after
			? `<span class="mood-indicator mood-${entry.mood_after}"></span>`
			: "";

		const tagsHtml = entry.tags
			.map((tag) => `<span class="tag">${tag}</span>`)
			.join("");

		const content = entry.is_encrypted
			? "[ENCRYPTED - Click to decrypt]"
			: entry.content.substring(0, 200) +
			  (entry.content.length > 200 ? "..." : "");

		div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="mb-0">${entry.title || "Untitled"}</h5>
            <small class="text-muted">${new Date(
							entry.created_at
						).toLocaleDateString()}</small>
        </div>
        <div class="mb-2">
            ${moodBeforeHtml}
            <small class="text-muted">Before: ${
							entry.mood_before || "N/A"
						}</small>
            ${moodAfterHtml}
            <small class="text-muted">After: ${
							entry.mood_after || "N/A"
						}</small>
        </div>
        <p class="mb-2">${content}</p>
        <div class="mb-2">${tagsHtml}</div>
        <div class="text-right">
            ${
							entry.is_encrypted
								? '<button class="btn decrypt-btn btn-sm" onclick="decryptEntry(' +
								  entry.id +
								  ')">Decrypt</button>'
								: ""
						}
            <button class="btn btn-outline-primary btn-sm" onclick="viewEntry(${
							entry.id
						})">View</button>
        </div>
    `;

		return div;
	}

	function handleSearch() {
		currentSearch = document.getElementById("search-input").value.trim();
		resetAndLoadEntries();
	}

	function resetAndLoadEntries() {
		currentOffset = 0;
		loadEntries(true);
	}

	function loadMoreEntries() {
		loadEntries(false);
	}

	function addTag() {
		const input = document.getElementById("tag-input");
		const tag = input.value.trim();
		if (tag) {
			const tags = getCurrentTags();
			if (!tags.includes(tag)) {
				tags.push(tag);
				updateTagsDisplay(tags);
			}
			input.value = "";
		}
	}

	function getCurrentTags() {
		const tagElements = document.querySelectorAll("#tags-display .tag");
		return Array.from(tagElements).map((el) =>
			el.textContent.replace("×", "").trim()
		);
	}

	function updateTagsDisplay(tags) {
		const display = document.getElementById("tags-display");
		display.innerHTML = tags
			.map(
				(tag) => `
        <span class="tag">
            ${tag}
            <button type="button" class="btn btn-sm" onclick="removeTag('${tag}')">&times;</button>
        </span>
    `
			)
			.join("");
	}

	function removeTag(tag) {
		const tags = getCurrentTags().filter((t) => t !== tag);
		updateTagsDisplay(tags);
	}

	function resetForm() {
		document.getElementById("journal-form").reset();
		document.getElementById("tags-display").innerHTML = "";
		document.getElementById("encrypt-entry").checked = true;
	}

	function viewEntry(entryId) {
		fetch(`/api/journal/entry/${entryId}`)
			.then((response) => response.json())
			.then((data) => {
				if (data.entry) {
					showEntryModal(data.entry);
				}
			})
			.catch((error) => console.error("Error loading entry:", error));
	}

	function decryptEntry(entryId) {
		fetch(`/api/journal/entry/${entryId}?decrypt=true`)
			.then((response) => response.json())
			.then((data) => {
				if (data.entry) {
					// Update the entry element with decrypted content
					const entryElement = document.querySelector(
						`[data-entry-id="${entryId}"]`
					);
					if (entryElement) {
						const contentElement = entryElement.querySelector("p");
						contentElement.textContent = data.entry.content;
						entryElement.classList.remove("encrypted");
						const decryptBtn = entryElement.querySelector(".decrypt-btn");
						if (decryptBtn) decryptBtn.remove();
					}
				}
			})
			.catch((error) => console.error("Error decrypting entry:", error));
	}

	function showEntryModal(entry) {
		const modal = document.getElementById("entryModal");
		document.getElementById("entryModalTitle").textContent =
			entry.title || "Untitled";

		const moodBeforeHtml = entry.mood_before
			? `<span class="mood-indicator mood-${entry.mood_before}"></span>`
			: "";
		const moodAfterHtml = entry.mood_after
			? `<span class="mood-indicator mood-${entry.mood_after}"></span>`
			: "";
		const tagsHtml = entry.tags
			.map((tag) => `<span class="tag">${tag}</span>`)
			.join("");

		document.getElementById("entryModalBody").innerHTML = `
        <div class="mb-3">
            <strong>Date:</strong> ${new Date(
							entry.created_at
						).toLocaleString()}
        </div>
        <div class="mb-3">
            <strong>Mood Before:</strong> ${moodBeforeHtml} ${
			entry.mood_before || "N/A"
		}
            <br>
            <strong>Mood After:</strong> ${moodAfterHtml} ${
			entry.mood_after || "N/A"
		}
        </div>
        <div class="mb-3">
            <strong>Tags:</strong> ${tagsHtml || "None"}
        </div>
        <div class="mb-3">
            <strong>Content:</strong>
            <div class="mt-2 p-3 bg-light rounded">${entry.content.replace(
							/\n/g,
							"<br>"
						)}</div>
        </div>
    `;

		$(modal).modal("show");
	}

	function showNotification(message, type) {
		// Simple notification - you can enhance this with a proper notification system
		const notification = document.createElement("div");
		notification.className = `alert alert-${
			type === "success" ? "success" : "danger"
		} alert-dismissible fade show`;
		notification.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;

		document
			.querySelector(".container-fluid")
			.insertBefore(
				notification,
				document.querySelector(".container-fluid").firstChild
			);

		setTimeout(() => {
			$(notification).alert("close");
		}, 3000);
	}

	function debounce(func, wait) {
		let timeout;
		return function executedFunction(...args) {
			const later = () => {
				clearTimeout(timeout);
				func(...args);
			};
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
		};
	}
</script>
{% endblock %}
